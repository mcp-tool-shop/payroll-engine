name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  DATABASE_URL: postgresql://payroll:payroll_dev@localhost:5432/payroll_dev

jobs:
  # ===========================================================================
  # Core-Only Job: Enterprise Adoptability Test
  # ===========================================================================
  # This is the MOST IMPORTANT job. It ensures that:
  # 1. Core PSP works without optional dependencies
  # 2. AI is disabled by default
  # 3. Rules-baseline works without [ai] extras
  core-only:
    name: Core Only (No Extras)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install core only (no extras)
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          # Explicitly verify AI ML extras are NOT installed
          python -c "import sys; assert 'numpy' not in sys.modules, 'numpy should not be installed'"
          python -c "import sys; assert 'sklearn' not in sys.modules, 'sklearn should not be installed'"

      - name: Verify core imports work
        run: |
          python -c "from payroll_engine.psp import PSP, PSPConfig, LedgerConfig, FundingGateConfig"
          python -c "from payroll_engine.psp import DomainEvent"
          python -c "from payroll_engine.psp.providers import PaymentRailProvider"
          echo "PASS: Core imports work without extras"

      - name: Verify AI disabled by default
        run: |
          python -c "
          from payroll_engine.psp.ai import AdvisoryConfig
          config = AdvisoryConfig()
          assert config.enabled is False, 'AI MUST be disabled by default'
          print('PASS: AI disabled by default')
          "

      - name: Verify rules-baseline works without extras
        run: |
          python -c "
          from payroll_engine.psp.ai import is_ai_available, STDLIB_MODELS
          assert is_ai_available('rules_baseline'), 'rules_baseline MUST always work'
          assert 'rules_baseline' in STDLIB_MODELS
          print('PASS: rules_baseline available without extras')
          "

      - name: Verify two-tier error messaging
        run: |
          python -c "
          from payroll_engine.psp.ai import AINotInstalledError
          error = AINotInstalledError('gradient_boost')
          msg = str(error)
          assert 'pip install payroll-engine[ai]' in msg, 'Error must include install instructions'
          assert 'rules_baseline' in msg, 'Error must suggest rules_baseline alternative'
          print('PASS: Error messaging includes install instructions and alternative')
          "

  # ===========================================================================
  # Lint and Type Check (Fast, no DB)
  # ===========================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff pyright
          pip install -e ".[dev]"

      - name: Lint with ruff
        run: ruff check src/ tests/

      - name: Type check with pyright
        run: pyright src/

  # ===========================================================================
  # Unit Tests (No DB)
  # ===========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/ -v \
            --ignore=tests/psp/test_red_team_scenarios.py \
            --ignore=tests/psp/integration/ \
            -x --tb=short

  # ===========================================================================
  # Database Integration Tests
  # ===========================================================================
  db-tests:
    name: Database Integration Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: payroll
          POSTGRES_PASSWORD: payroll_dev
          POSTGRES_DB: payroll_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install psycopg2-binary

      - name: Apply migrations
        run: python scripts/migrate.py

      - name: Run PSP integration tests
        run: |
          pytest tests/psp/ -v \
            --tb=short \
            -x

  # ===========================================================================
  # Migration Linter
  # ===========================================================================
  migration-lint:
    name: Migration Linter
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparing

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check migration numbering
        run: |
          echo "Checking migration file numbering..."
          cd psp_build_pack_v2/psp_build_pack/migrations

          # Get all SQL files
          files=$(ls -1 *.sql 2>/dev/null | sort)

          if [ -z "$files" ]; then
            echo "No migration files found"
            exit 0
          fi

          # Check numbering is sequential
          prev_num=0
          for file in $files; do
            num=$(echo "$file" | grep -oE '^[0-9]+' || echo "0")
            if [ "$num" -le "$prev_num" ]; then
              echo "ERROR: Migration $file has invalid number (must be > $prev_num)"
              exit 1
            fi
            prev_num=$num
            echo "  OK: $file"
          done

          echo "All migrations properly numbered!"

      - name: Check for destructive changes in migrations
        run: |
          echo "Checking for potentially destructive changes..."
          cd psp_build_pack_v2/psp_build_pack/migrations

          # Patterns that require extra review
          destructive_patterns="DROP TABLE|DROP COLUMN|ALTER.*TYPE|TRUNCATE"

          for file in *.sql; do
            if grep -iE "$destructive_patterns" "$file" > /dev/null 2>&1; then
              echo "WARNING: $file contains potentially destructive changes:"
              grep -iE "$destructive_patterns" "$file" | head -5
              echo ""
            fi
          done

          # Don't fail, just warn (destructive changes are sometimes needed)
          echo "Review complete. Check any warnings above."

  # ===========================================================================
  # Database Constraint Tests (Red Team)
  # ===========================================================================
  constraint-tests:
    name: Database Constraint Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: payroll
          POSTGRES_PASSWORD: payroll_dev
          POSTGRES_DB: payroll_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install psycopg2-binary

      - name: Apply migrations
        run: python scripts/migrate.py

      - name: Run red team tests
        run: |
          pytest tests/psp/test_red_team_scenarios.py -v \
            --tb=long

      - name: Verify constraints actually work
        run: |
          echo "Testing that impossible states are rejected..."

          # Test that negative amounts are rejected
          python -c "
          from sqlalchemy import create_engine, text
          import os

          engine = create_engine(os.environ['DATABASE_URL'])
          with engine.connect() as conn:
              # Try to insert negative amount
              try:
                  conn.execute(text('''
                      INSERT INTO psp_ledger_entry (
                          tenant_id, legal_entity_id, entry_type,
                          debit_account_id, credit_account_id, amount,
                          source_type, source_id, idempotency_key
                      ) VALUES (
                          gen_random_uuid(), gen_random_uuid(), 'test',
                          gen_random_uuid(), gen_random_uuid(), -100.00,
                          'test', gen_random_uuid(), 'negative_test'
                      )
                  '''))
                  print('FAIL: Negative amount was accepted!')
                  exit(1)
              except Exception as e:
                  if 'violates check constraint' in str(e).lower():
                      print('OK: Negative amount rejected by constraint')
                  else:
                      print(f'FAIL: Unexpected error: {e}')
                      exit(1)
          "

          echo "Constraint verification passed!"

  # ===========================================================================
  # Event Schema Compatibility
  # ===========================================================================
  event-compat:
    name: Event Schema Compatibility
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check event schema compatibility
        run: python scripts/check_event_compat.py

  # ===========================================================================
  # Demo Smoke Test
  # ===========================================================================
  demo-test:
    name: Demo Smoke Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: payroll
          POSTGRES_PASSWORD: payroll_dev
          POSTGRES_DB: payroll_dev
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install psycopg2-binary

      - name: Apply migrations
        run: python scripts/migrate.py

      - name: Run demo
        run: |
          python examples/psp_minimal/main.py
          echo ""
          echo "Demo completed successfully!"

  # ===========================================================================
  # All Checks Must Pass
  # ===========================================================================
  all-checks:
    name: All Checks
    needs: [core-only, lint, unit-tests, db-tests, migration-lint, constraint-tests, event-compat, demo-test]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "All CI checks passed!"
